{% extends "base/base.html.twig" %}

{% block title %}Casu'Hall - Mon panier{% endblock %}

{% block body %}
    {% set alertTypes = {'success': 'success', 'warning': 'warning', 'error': 'danger'} %}
    {% for type, cssClass in alertTypes %}
        {% for message in app.flashes(type) %}
            <div class="container-fluid d-flex align-items-center text-center justify-content-center mb-2 mt-3">
                <div class="alert alert-dismissible alert-{{ cssClass }} text-center" data-alert>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    {{ message }}
                </div>
            </div>
        {% endfor %}
    {% endfor %}

    {% set totalPrice = 0.0 %}
    {% set panier = app.user ? panier : emptyUserPanier %}
    {% set quantityToEmptyUser = 1 %}

    {% if panier|length > 0 %}
        <h4 class="mt-3 text-uppercase text-center fw-bold mb-3">Mon panier</h4>
        <div class="container-fluid mt-4 d-flex align-items-center justify-content-center">    
            <div class="row w-100 justify-content-center">
                <div class="col-md-7">
                    {% for panierDetail in panier %}
                        <div id="{{ app.user ? panierDetail.article.id : panierDetail.id }}" class="row border border-2 shadow shadow-lg mb-4">
                            <div class="col-md-3 p-0">
                                <img src="{{ asset('assets/uploads/articles/300x300-' ~ (app.user ? panierDetail.article.images[0].name : panierDetail.images[0].name)) }}" class="img-fluid resize-image" alt="{{ app.user ? panierDetail.article.nomArticle : panierDetail.nomArticle }}">
                            </div>
                            <div class="col-md-7">
                                <div class="d-flex mt-3">
                                    <h5 class="text-uppercase mb-2 text-start me-2">{{ app.user ? panierDetail.article.nomArticle : panierDetail.nomArticle }} </h5>
                                    <h5> - </h5>
                                    <h5 id="price {{ app.user ? panierDetail.article.id : panierDetail.id }}" class="text-danger fw-bold ms-2"> 
                                        {{ (app.user ? panierDetail.article.prix : panierDetail.prix) | number_format(2, '.', ' ') }} €
                                    </h5>
                                </div>
                                <hr>
                                {% set description = app.user ? panierDetail.article.description : panierDetail.description %}
                                <p class="text-justify">{{ description|length > 100 ? description|slice(0, 110) ~ '...' : description }}</p>
                                <hr>
                                <h6 class="mb-3"> Taille {{ app.user ? panierDetail.article.taille : panierDetail.taille }}</h6>
                                <hr>
                                <div class="d-flex align-items-center">
                                    <div class="border border-2">
                                        {% if app.user %}
                                            {% set decrementLink = panierDetail.quantite > 1 ? path('panier.decrement', {'id': panierDetail.article.id }) %}
                                            {% set incrementLink = panierDetail.quantite >= panierDetail.article.quantiteStock ? '' : path('panier.increment', {'id': panierDetail.article.id }) %}
                                            
                                            {% if decrementLink %}
                                                <a href="{{ decrementLink }}">
                                            {% endif %}
                                                    <img src="/assets/images/moins.png" alt="moins" title="Décrémenter">
                                            {% if decrementLink %}
                                                </a>
                                            {% endif %}

                                            <label class="mx-2 p-2 text-center">{{ panierDetail.quantite }}</label>

                                            {% if incrementLink %}
                                                <a href="{{ incrementLink }}">
                                            {% endif %}
                                                <img src="/assets/images/plus.png" alt="plus" title="Incrémenter">
                                            {% if incrementLink %}
                                                </a>
                                            {% endif %}
                                        {% else %}
                                            <button id="decrease" class="btn btn-link p-0 border-0 bg-transparent" onclick="adjustPrice('decrease', {{ panierDetail.prix }}, {{ panierDetail.quantiteStock }}, {{ panierDetail.id }})"> 
                                                <img src="/assets/images/moins.png" alt="moins" title="Décrémenter">
                                            </button>

                                            <label id="quantity-{{panierDetail.id}}" class="mx-2 p-2 text-center"> {{ quantityToEmptyUser }} </label>

                                            <button id="increase" class="btn btn-link p-0 border-0 bg-transparent" onclick="adjustPrice('increase', {{ panierDetail.prix }}, {{ panierDetail.quantiteStock }}, {{ panierDetail.id }})">
                                                <img src="/assets/images/plus.png" alt="plus" title="Incrémenter">
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 d-flex flex-column align-items-center justify-content-center">
                                <a href="{{ path('article.favori', {'id': app.user ? panierDetail.article.id : panierDetail.id }) }}" 
                                class="btn btn-light border border-black mb-2 mx-2"> 
                                    <img src="/assets/images/favori_plein.png" class="img-fluid" alt="Ajouter aux favoris" title="Ajouter aux favoris">
                                </a>
                                <a href="{{ path('article.articleDetail', {'id': app.user ? panierDetail.article.id : panierDetail.id }) }}" 
                                class="btn btn-light border border-black mb-2 mx-2">
                                    <img src="/assets/images/oeil.png" class="img-fluid" alt="Voir le détail de l'article" title="Voir le détail de l'article">
                                </a>
                                <a href="{{ path('article.supprimerArticlePanier', {'id': app.user ? panierDetail.article.id : panierDetail.id }) }}" 
                                class="btn btn-light border-black mb-2 mx-2">
                                    <img src="/assets/images/supprimer.png" class="img-fluid" alt="Supprimer l'article du panier" title="Supprimer l'article du panier">
                                </a>
                            </div>
                        </div>
                        {% set totalPrice = totalPrice + (app.user ? panierDetail.prix : panierDetail.prix) %}
                    {% endfor %}
                </div>
                <div class="col-md-4 mb-2">
                    <div class="p-3 ms-5 sticky-top border border-2 w-100 shadow shadow-lg">
                        <h5 class="mb-3"> Récapitulatif de la commande </h5> 
                        <hr> 
                        <div>
                            {% set chaine = " article" %}
                            {% if app.user %}
                                {% if quantityArt > 1 %} 
                                    {% set chaine = chaine ~ "s" %}
                                {% endif %}
                                <p> Votre panier contient actuellement <strong> {{ quantityArt ~ chaine}}</strong> :</p>
                            {% else %}
                                <p> Votre panier contient actuellement : </p>
                            {% endif %}
                            
                            <ul>
                                {% for panierDetail in panier %}
                                    <li id="quantityRecap-{{panierDetail.id}}"> {{ app.user ? panierDetail.quantite : quantityToEmptyUser }} x {{ app.user ? panierDetail.article.nomArticle : panierDetail.nomArticle }} </li>
                                {% endfor %}
                            </ul>

                            <div class="d-flex mt-5">
                                <h5 class="fw-bold">Montant TTC :</h5>
                                <h5 id="totalPrice" class="ms-2 text-danger fw-bold">{{ totalPrice | number_format(2, '.', ' ') }} €</h5>
                            </div>
                            <hr>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="flexCheckDefault">
                                <label class="form-check-label small justify" for="flexCheckDefault">
                                    En cochant cette case, j'ai pris connaissance des 
                                    <a class="text-black" href="#">politiques de ventes</a> du site.
                                </label>
                            </div>
                            <div class="d-flex justify-content-center mt-3">
                                {% set chemin = app.user ? path('panier.payment') : path('security.connexion') %}
                                <a id="orderLink" href="{{chemin}}" class="btn btn-outline-success disabled" aria-disabled="true"> Passer la commande </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        {% include "/base/_notFoundPage.html.twig" with { sentence: "Vous n'avez pas d'articles dans votre panier."} %}
    {% endif %}
{% endblock %}
