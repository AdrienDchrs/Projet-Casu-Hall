{% extends "base.html.twig" %}

{% block title %}Casu'Hall - Mon panier{% endblock %}

{% block body %}
    {% set alertTypes = {'success': 'success', 'warning': 'warning', 'error': 'danger'} %}
    {% for type, cssClass in alertTypes %}
        {% for message in app.flashes(type) %}
            <div class="container-fluid d-flex align-items-center text-center justify-content-center mb-2 mt-3">
                <div class="alert alert-dismissible alert-{{ cssClass }} text-center" data-alert>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    {{ message }}
                </div>
            </div>
        {% endfor %}
    {% endfor %}

    {% set totalPrice = 0.0 %}
    {% set panier = app.user ? panier : emptyUserPanier %}

    {% if panier|length > 0 %}
        <div class="container-fluid mt-4 ps-5">
            <h4 class="mt-3 text-uppercase text-center fw-bold mb-3">Mon panier</h4>
            <div class="row">
                <div class="col-md-7 ps-5 me-2">
                    {% for panierDetail in panier %}
                        <div id="{{ app.user ? panierDetail.article.id : panierDetail.id }}" class="row mb-4 border border-2 shadow shadow-lg">

                            <div class="col-md-4 p-0">
                                {% set imageObject = app.user ? panierDetail.article : panierDetail %}
                                <img src="{{ vich_uploader_asset(imageObject, 'imageFile') }}" alt="Image de l'article" class="img-fluid d-block img-favori">
                            </div>

                            <div class="col-md-8">
                                <h4 class="text-uppercase mb-2 mt-4 text-start">{{ app.user ? panierDetail.article.nomArticle : panierDetail.nomArticle }}</h4>
                                <hr>
                                <h4 id="price {{ app.user ? panierDetail.article.id : panierDetail.id }}" class="text-danger fw-bold mb-2">{{ (app.user ? panierDetail.article.prix : panierDetail.prix) | number_format(2, '.', ' ') }} €</h4>
                                <hr>
                                <h6> Taille {{ app.user ? panierDetail.article.taille : panierDetail.taille }}</h6>
                                <hr>
                                {% set description = app.user ? panierDetail.article.description : panierDetail.description %}
                                <p class="text-justify">{{ description|length > 100 ? (description|slice(0, 100) ~ '...') : description }}</p>
                                <hr>
                                <div class="d-flex align-items-center">
                                    <div class="border border-2">
                                        {% if app.user %}
                                            {% set decrementLink = panierDetail.quantite == 1 ? '' : path('panier.decrement', {'id': panierDetail.article.id }) %}
                                            {% set incrementLink = panierDetail.quantite >= panierDetail.article.quantiteStock ? '' : path('panier.increment', {'id': panierDetail.article.id }) %}
                                            
                                            {% if decrementLink %}<a href="{{ decrementLink }}">{% endif %}<img src="/assets/images/moins.png" alt="moins" title="Décrémenter">{% if decrementLink %}</a>{% endif %}

                                            <label class="mx-2 p-2 text-center">{{ panierDetail.quantite }}</label>

                                            {% if incrementLink %}<a href="{{ incrementLink }}">{% endif %}<img src="/assets/images/plus.png" alt="plus" title="Incrémenter">{% if incrementLink %}</a>{% endif %}
                                    
                                        {% else %}
                                            {% set quantity = 1 %}
                                            <button id="decrease" class="btn btn-link p-0 border-0 bg-transparent" onclick="adjustPrice('decrease', {{ panierDetail.prix }}, {{ panierDetail.quantiteStock }}, {{ panierDetail.id }})"> 
                                                <img src="/assets/images/moins.png" alt="moins" title="Décrémenter">
                                            </button>

                                            <label id="quantity {{ panierDetail.id }}" class="mx-2 p-2 text-center"> {{ quantity }} </label>

                                            <button id="increase" class="btn btn-link p-0 border-0 bg-transparent" onclick="adjustPrice('increase', {{ panierDetail.prix }}, {{ panierDetail.quantiteStock }}, {{ panierDetail.id }})">
                                                <img src="/assets/images/plus.png" alt="plus" title="Incrémenter">
                                            </button>
                                        
                                        {% endif %}
                                    </div>
                                </div>

                                <div class="d-flex align-items-center justify-content-center">
                                    <a href="{{ path('article.favori', {'id': app.user ? panierDetail.article.id : panierDetail.id }) }}" class="btn btn-light border border-black mb-2 mx-2"> 
                                        <img src="/assets/images/favori_plein.png" class="img-fluid" alt="Ajouter aux favoris" title="Ajouter aux favoris">
                                    </a>
                                    <a href="{{ path('article.articleDetail', {'id': app.user ? panierDetail.article.id : panierDetail.id }) }}" class="btn btn-light border border-black mb-2 mx-2">
                                        <img src="/assets/images/oeil.png" class="img-fluid" alt="Voir le détail de l'article" title="Voir le détail de l'article">
                                    </a>
                                    <a href="{{ path('article.supprimerArticlePanier', {'id': app.user ? panierDetail.article.id : panierDetail.id }) }}" class="btn btn-light border-black mb-2 mx-2">
                                        <img src="/assets/images/supprimer.png" class="img-fluid" alt="Supprimer l'article du panier" title="Supprimer l'article du panier">
                                    </a>
                                </div>
                            </div>
                        </div> 
                        {% set totalPrice = totalPrice + (app.user ? panierDetail.prix : panierDetail.prix) %}
                    {% endfor %}
                </div>

                <div class="col-md-4">
                    <div class="p-3 sticky-top pt-4 border border-2 ms-5 w-100  shadow shadow-lg">
                        <h5 class="mb-3"> Récapitulatif de la commande </h5> 
                        <hr> 
                        <div>
                            {% if quantityArt == 1 %} 
                                {% set chaines = " article" %}
                            {% else %}
                                {% set chaines = " articles" %}
                            {% endif %}
                                
                            <p> Votre panier contient actuellement <strong> {{ quantityArt ~ chaines}}. </strong> </p>
                            <p> Livraison offerte en France !</p>
                            <div class="d-flex fw-bold">
                                <p>Prix TTC :</p>
                                <p id="totalPrice" class="ms-2 text-danger">{{ totalPrice | number_format(2, '.', ' ') }} €</p>
                            </div>
                            <hr>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="flexCheckDefault">
                                <label class="form-check-label small justify" for="flexCheckDefault">
                                    En cochant cette case, j'ai pris connaissance des 
                                    <a class="text-black" href="#">politiques de ventes</a> de l'entreprise.
                                </label>
                            </div>
                            <div class="d-flex justify-content-center mt-3">
                                {% set chemin = app.user ? path('panier.payment') : path('security.connexion') %}
                                <button id="orderButton" class="btn btn-outline-success text-center" disabled onclick="redirectToOrder('{{ chemin }}')">Passer la commande</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        {% include "/base/_notFoundPage.html.twig" with { sentence: "Vous n'avez pas d'articles dans votre panier."} %}
    {% endif %}
{% endblock %}
